<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Your Email - Snevo</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="../assets/css/main.css" rel="stylesheet">
    <link href="../assets/css/animations.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../assets/images/favicon.ico">
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand fw-bold fs-2" href="index.html">SNEVO</a>
            
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-light" onclick="authManager.logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Email Verification Section -->
    <section class="verification-section py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-6 col-md-8">
                    <div class="card shadow-lg border-0">
                        <div class="card-body p-5 text-center">
                            <!-- Email Icon -->
                            <div class="mb-4">
                                <i class="fas fa-envelope-open-text text-primary" style="font-size: 4rem;"></i>
                            </div>
                            
                            <!-- Title -->
                            <h2 class="card-title mb-3">Verify Your Email Address</h2>
                            
                            <!-- Message -->
                            <p class="text-muted mb-4">
                                We've sent a verification email to <strong id="userEmail">your email address</strong>. 
                                Please check your inbox and click the verification link to activate your account.
                            </p>
                            
                            <!-- Status Messages -->
                            <div id="statusMessage" class="mb-4"></div>
                            
                            <!-- Actions -->
                            <div class="d-grid gap-3">
                                <button id="resendBtn" class="btn btn-primary btn-lg">
                                    <i class="fas fa-paper-plane me-2"></i>Resend Verification Email
                                </button>
                                
                                <button id="checkStatusBtn" class="btn btn-outline-secondary">
                                    <i class="fas fa-sync-alt me-2"></i>Check Verification Status
                                </button>
                                
                                <hr class="my-3">
                                
                                <a href="index.html" class="btn btn-outline-primary">
                                    <i class="fas fa-home me-2"></i>Continue Browsing (Limited Access)
                                </a>
                            </div>
                            
                            <!-- Info -->
                            <div class="mt-4 p-3 bg-light rounded">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Note:</strong> You can browse products but cannot make purchases until your email is verified.
                                    Didn't receive the email? Check your spam folder or click resend.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Configuration -->
    <script src="../assets/js/config.js"></script>
    
    <!-- Custom Scripts -->
    <script type="module" src="../assets/js/ApiClient.js"></script>
    <script type="module" src="../assets/js/AuthManager.js"></script>
    
    <script>
        class EmailVerificationPage {
            constructor() {
                this.userEmail = null;
                this.resendBtn = document.getElementById('resendBtn');
                this.checkStatusBtn = document.getElementById('checkStatusBtn');
                this.statusMessage = document.getElementById('statusMessage');
                
                this.init();
            }
            
            async init() {
                // Wait for AuthManager to be available
                await this.waitForAuthManager();
                
                // Check if user is logged in and get their email
                if (authManager.isAuthenticated() && authManager.currentUser) {
                    this.userEmail = authManager.currentUser.email;
                    document.getElementById('userEmail').textContent = this.userEmail;
                    
                    // Check if user is already verified
                    if (!authManager.requiresEmailVerification()) {
                        this.showSuccess('Your email is already verified!');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                        return;
                    }
                } else {
                    // Not logged in, redirect to login
                    window.location.href = 'login.html';
                    return;
                }
                
                this.setupEventListeners();
            }
            
            async waitForAuthManager() {
                while (typeof authManager === 'undefined') {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            setupEventListeners() {
                this.resendBtn.addEventListener('click', () => this.resendVerification());
                this.checkStatusBtn.addEventListener('click', () => this.checkVerificationStatus());
                
                // Listen for auth events
                authManager.on('verificationResent', (data) => {
                    this.showSuccess('Verification email sent successfully! Please check your inbox.');
                });
                
                authManager.on('verificationResendError', (data) => {
                    this.showError(data.error);
                });
            }
            
            async resendVerification() {
                if (!this.userEmail) return;
                
                this.resendBtn.disabled = true;
                this.resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
                
                try {
                    await authManager.resendVerification(this.userEmail);
                } catch (error) {
                    this.showError('Failed to resend verification email');
                } finally {
                    setTimeout(() => {
                        this.resendBtn.disabled = false;
                        this.resendBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Resend Verification Email';
                    }, 3000);
                }
            }
            
            async checkVerificationStatus() {
                this.checkStatusBtn.disabled = true;
                this.checkStatusBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Checking...';
                
                try {
                    // Refresh user session to get latest verification status
                    const response = await authAPI.getProfile();
                    if (response.success && response.data.user.email_verified) {
                        this.showSuccess('Email verified successfully! Redirecting...');
                        authManager.currentUser.email_verified = true;
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                    } else {
                        this.showInfo('Email not yet verified. Please check your inbox and click the verification link.');
                    }
                } catch (error) {
                    this.showError('Failed to check verification status');
                } finally {
                    this.checkStatusBtn.disabled = false;
                    this.checkStatusBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Check Verification Status';
                }
            }
            
            showSuccess(message) {
                this.statusMessage.innerHTML = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i>${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }
            
            showError(message) {
                this.statusMessage.innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }
            
            showInfo(message) {
                this.statusMessage.innerHTML = `
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <i class="fas fa-info-circle me-2"></i>${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new EmailVerificationPage();
        });
    </script>
</body>
</html>
